esphome:
  name: esphome-web-10c200
  friendly_name: "Itho HRU 400 Ventilation Modbus Controller"
  min_version: 2024.6.0
  name_add_mac_suffix: false
  project:
    name: esphome.web
    version: '1.0'

esp32:
  board: esp32dev
  framework:
    type: arduino

# Enable logging
logger:
  # level: DEBUG

# Enable Home Assistant API
api:

# Allow Over-The-Air updates
ota:
- platform: esphome

# Allow provisioning Wi-Fi via serial
# improv_serial:

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  # Set up a wifi access point
  ap: {}

# In combination with the `ap` this allows the user
# to provision wifi credentials to the device via WiFi AP.
captive_portal:

# dashboard_import:
#   package_import_url: github://esphome/example-configs/esphome-web/esp32.yaml@main
#   import_full_config: true

# # Sets up Bluetooth LE (Only on ESP32) to allow the user
# # to provision wifi credentials to the device.
# esp32_improv:
#   authorizer: none

# To have a "next url" for improv serial
web_server:

modbus:
  - id: modbus_hru
    uart_id: uart_modbus_hru
  
uart:
  - id: uart_modbus_hru
    tx_pin: GPIO19
    rx_pin: GPIO22
    baud_rate: 19200
    parity: even
    data_bits: 8
    stop_bits: 1
  
modbus_controller:
  - id: hru
    address: 72 # the Modbus device addr, was 0x1
    modbus_id: modbus_hru
    update_interval: 10s
    setup_priority: -10
    command_throttle: 200ms
  
sensor:
  # These 3 are configured as read-only for now, but they are R/W
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40001 Modbus address"
    id: hru_modbus_address
    register_type: holding
    address: 0 # 0x000E
    value_type: U_WORD
    skip_updates: 60
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40002 Baud rate"
    id: hru_baud_rate
    register_type: holding
    address: 1 # 0x000E
    value_type: U_WORD
    skip_updates: 60
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40003 Parity"
    id: hru_parity
    register_type: holding
    address: 2 # 0x000E
    value_type: U_WORD
    skip_updates: 60

  # Read-only status registers
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40011 Manufacturer group"
    id: hru_manufacturer_group
    register_type: holding
    address: 10 # 0x000E
    value_type: U_WORD
    skip_updates: 60
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40012 Manufacturer sub-ID"
    id: hru_manufacturer_subid
    register_type: holding
    address: 11 # 0x000E
    value_type: U_WORD
    skip_updates: 60
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40013 Product ID"
    id: hru_product_id
    register_type: holding
    address: 12 # 0x000E
    value_type: U_WORD
    skip_updates: 60
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40014 Software version"
    id: hru_software_version
    register_type: holding
    address: 13 # 0x000E
    value_type: U_WORD
    skip_updates: 60
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40015 Software revision"
    id: hru_software_revision
    register_type: holding
    address: 14 # 0x000E
    value_type: U_WORD
    skip_updates: 60
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40016 List version"
    id: hru_list_version
    register_type: holding
    address: 15 # 0x000E
    value_type: U_WORD
    skip_updates: 60
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40017 OEM code"
    id: hru_oem_code
    register_type: holding
    address: 16 # 0x000E
    value_type: U_WORD
    skip_updates: 60
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40101 Serial number"
    id: hru_serial_number
    register_type: holding
    address: 100 # 0x000E
    value_type: U_QWORD
    skip_updates: 60
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40200 Error number"
    id: hru_error_number
    register_type: holding
    address: 199 # 0x000E
    value_type: U_WORD
    # unit_of_measurement: "errornr"
    icon: mdi:alert-circle

  # [E][modbus_controller:088]: Modbus error function code: 0x3 exception: 2
  # [E][modbus_controller:097]: Modbus error - last command: function code=0x3  register address = 0xBB8  registers count=2 payload size=0
  # - platform: modbus_controller
  #   modbus_controller_id: hru
  #   name: "43001 Highest % supply automode"
  #   id: hru_supply_maxperc
  #   register_type: holding
  #   address: 3000 # 0x000E
  #   value_type: U_WORD
  #   unit_of_measurement: "%"
  # - platform: modbus_controller
  #   modbus_controller_id: hru
  #   name: "43002 Highest % exhaust automode"
  #   id: hru_exhaust_maxperc
  #   register_type: holding
  #   address: 3001 # 0x000E
  #   value_type: U_WORD
  #   unit_of_measurement: "%"
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43011 Highest % RV non-fan"
    id: hru_RV_ext_maxperc
    register_type: holding
    address: 3010 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "%"
    icon: mdi:water-percent
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43012 Highest measured CO2 ppm"
    id: hru_co2_maxppm
    register_type: holding
    address: 3011 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "ppm"
    icon: mdi:molecule-co2
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43021 Supply fan RPM"
    id: hru_rpm_supplyfan
    register_type: holding
    address: 3020 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "rpm"
    icon: mdi:speedometer
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43022 Exhaust fan RPM"
    id: hru_rpm_exhaustfan
    register_type: holding
    address: 3021 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "rpm"
    icon: mdi:speedometer
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43023 Supply fan power"
    id: hru_pwr_supplyfan
    register_type: holding
    address: 3022 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "W"
    icon: mdi:flash
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43024 Exhaust fan power"
    id: hru_pwr_exhaustfan
    register_type: holding
    address: 3023 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "W" 
    icon: mdi:flash
  # The following is covered by 4 bitmasked entries in binary_sensor below
  # - platform: modbus_controller
  #   modbus_controller_id: hru
  #   name: "43025 Connected zone valves"
  #   id: hru_zone_valves_connected
  #   register_type: holding
  #   address: 3024 # 0x000E
  #   value_type: U_WORD
  #   skip_updates: 60
  #   icon: mdi:connection

  # Supply from outside
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43031 Supply flow from outside"
    id: hru_m3h_supply_external
    register_type: holding
    address: 3030 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "m3/h"
    icon: mdi:home-import-outline
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43032 Supply flow from outside"
    id: hru_kgh_supply_external
    register_type: holding
    address: 3031 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "kg/h"
    icon: mdi:home-import-outline
  - platform: modbus_controller # 0x91 type, signed 16bit/10
    modbus_controller_id: hru
    name: "43033 Supply temperature from outside"
    id: hru_temp_supply_external
    register_type: holding
    address: 3032 # 0x000E
    value_type: S_WORD
    filters:
      - multiply: 0.1
    unit_of_measurement: "°C"
    icon: mdi:thermometer-chevron-down
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43034 Supply humidity from outside"
    id: hru_hum_supply_external
    register_type: holding
    address: 3033 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "%"
    icon: mdi:water-percent

  # Supply flow through frost valve
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43041 Supply flow frost valve"
    id: hru_m3h_supply_frostvalve
    register_type: holding
    address: 3040 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "m3/h"
    icon: mdi:snowflake

  # Supply mixed
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43051 Supply flow mixed"
    id: hru_m3h_supply_mixed
    register_type: holding
    address: 3050 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "m3/h"
    icon: mdi:home-import-outline
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43052 Supply flow mixed"
    id: hru_kgh_mixed
    register_type: holding
    address: 3051 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "kg/h"
    icon: mdi:home-import-outline
  - platform: modbus_controller # 0x91 type, signed 16bit/10
    modbus_controller_id: hru
    name: "43053 Supply temperature mixed"
    id: hru_temp_supply_mixed
    register_type: holding
    address: 3052 # 0x000E
    value_type: S_WORD
    filters:
      - multiply: 0.1
    unit_of_measurement: "°C"
    icon: mdi:thermometer-chevron-down
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43054 Supply humidity mixed"
    id: hru_hum_supply_mixed
    register_type: holding
    address: 3053 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "%"
    icon: mdi:water-percent

  # Supply to inside
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43061 Supply flow to inside"
    id: hru_m3h_supply_internal
    register_type: holding
    address: 3060 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "m3/h"
    icon: mdi:home-import-outline
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43062 Supply flow to inside"
    id: hru_kgh_supply_internal
    register_type: holding
    address: 3061 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "kg/h"
    icon: mdi:home-import-outline
  - platform: modbus_controller # 0x91 type, signed 16bit/10
    modbus_controller_id: hru
    name: "43063 Supply temperature to inside"
    id: hru_temp_supply_internal
    register_type: holding
    address: 3062 # 0x000E
    value_type: S_WORD
    filters:
      - multiply: 0.1
    unit_of_measurement: "°C"
    icon: mdi:thermometer-chevron-down
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43063 Supply humidity to inside"
    id: hru_hum_supply_internal
    register_type: holding
    address: 3063 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "%"
    icon: mdi:water-percent

  # Exhaust from inside
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43071 Exhaust flow from inside"
    id: hru_m3h_exhaust_internal
    register_type: holding
    address: 3070 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "m3/h"
    icon: mdi:home-export-outline
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43072 Exhaust flow from inside"
    id: hru_kgh_exhaust_internal
    register_type: holding
    address: 3071 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "kg/h"
    icon: mdi:home-export-outline
  - platform: modbus_controller # 0x91 type, signed 16bit/10
    modbus_controller_id: hru
    name: "43073 Exhaust temperature from inside"
    id: hru_temp_exhaust_internal
    register_type: holding
    address: 3072 # 0x000E
    value_type: S_WORD
    filters:
      - multiply: 0.1
    unit_of_measurement: "°C"
    icon: mdi:thermometer-chevron-up
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43074 Exhaust humidity from inside"
    id: hru_hum_exhaust_internal
    register_type: holding
    address: 3073 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "%"
    icon: mdi:water-percent
    # WTF is this? Disabled from the original source
    # filters:
    #   - or:
    #       - delta: 1
    #       - heartbeat: 60s
    #   - lambda: 
    #       float rand1 = rand() % 1;        
    #       return x + rand1;

  # Exhaust to outside
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43081 Exhaust flow to outside"
    id: hru_m3h_exhaust_external
    register_type: holding
    address: 3080 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "m3/h"
    icon: mdi:home-export-outline
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43082 Exhaust flow to outside"
    id: hru_kgh_exhaust_external
    register_type: holding
    address: 3081 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "kg/h"
    icon: mdi:home-export-outline
  - platform: modbus_controller # 0x91 type, signed 16bit/10
    modbus_controller_id: hru
    name: "43082 Exhaust temperature to outside"
    id: hru_temp_exhaust_external
    register_type: holding
    address: 3082 # 0x000E
    value_type: S_WORD
    filters:
    - multiply: 0.1
    unit_of_measurement: "°C"
    icon: mdi:thermometer-chevron-up
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43082 Exhaust humidity to outside"
    id: hru_hum_exhaust_external
    register_type: holding
    address: 3083 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "%"
    icon: mdi:water-percent
  
  # Flow demand
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43201 Zone 1 flow demand"
    id: hru_m3h_ask_zone1
    register_type: holding
    address: 3200 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "m3/h"
    icon: mdi:fan-speed-1
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43202 Zone 2 flow demand"
    id: hru_m3h_ask_zone2
    register_type: holding
    address: 3201 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "m3/h"
    icon: mdi:fan-speed-2
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43203 Zone 3 flow demand"
    id: hru_m3h_ask_zone3
    register_type: holding
    address: 3202 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "m3/h"
    icon: mdi:fan-speed-3
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43204 Zone 4 flow demand"
    id: hru_m3h_ask_zone4
    register_type: holding
    address: 3203 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "m3/h"
    icon: mdi:fan-plus
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43205 Zone 5 flow demand"
    id: hru_m3h_ask_zone5
    register_type: holding
    address: 3204 # 0x000E
    value_type: U_WORD
    unit_of_measurement: "m3/h"
    icon: mdi:fan-plus
  
  # Read-only 32-bit counters
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "44001-2 Lifetime counter"
    id: hru_lifetime_counter
    register_type: holding
    address: 4000 # 0x000E
    value_type: U_DWORD
    unit_of_measurement: "h"
    skip_updates: 6
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "44003-4 Mixed flow counter"
    id: hru_mixed_flow_counter
    register_type: holding
    address: 4002 # 0x000E
    value_type: U_DWORD
    unit_of_measurement: "m3"
    skip_updates: 6
    icon: mdi:counter

binary_sensor:
  # Bypass valve position a boolean (0 -> open -> true, 550 -> closed -> false)
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42033 Bypass position [bool]"
    id: hru_bypass_valve_pos_bool
    register_type: holding
    address: 2032 # 0x000E
    lambda: |-
      ESP_LOGD("main", "Modbus Bypass valve incoming state = %i", x);
      return !x;
    icon: mdi:valve
  # Zone valves connected
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43025 Zone 1 valve connected"
    id: hru_zone1_valve_connected
    register_type: holding
    skip_updates: 60
    address: 3024 # 0x000E
    bitmask: 0x1 # bit 0
    icon: mdi:connection
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43025 Zone 2 valve connected"
    id: hru_zone2_valve_connected
    register_type: holding
    skip_updates: 60
    address: 3024 # 0x000E
    bitmask: 0x2 # bit 1
    icon: mdi:connection
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43025 Zone 3 valve connected"
    id: hru_zone3_valve_connected
    register_type: holding
    skip_updates: 60
    address: 3024 # 0x000E
    bitmask: 0x8 # bit 3
    icon: mdi:connection
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "43025 Zone 4 valve connected"
    id: hru_zone4_valve_connected
    register_type: holding
    skip_updates: 60
    address: 3024 # 0x000E
    bitmask: 0x10 # bit 4
    icon: mdi:connection

switch:
  # [E][modbus_controller:088]: Modbus error function code: 0x3 exception: 2
  # [E][modbus_controller:097]: Modbus error - last command: function code=0x3  register address = 0x1F3  registers count=1 payload size=0
  # # Write-only register to reboot unit
  # - platform: modbus_controller
  #   modbus_controller_id: hru
  #   name: "40500 Reboot unit"
  #   id: hru_reboot
  #   register_type: holding
  #   address: 499
  #   # value_type: U_WORD
  #   bitmask: 0x1
  #   # skip_updates: 6
  #   # use_write_multiple: true
  #   icon: mdi:power-cycle

  # Fails when trying to flip the switch:
  # [E][modbus_controller:088]: Modbus error function code: 0x6 exception: 1
  # [E][modbus_controller:097]: Modbus error - last command: function code=0x6  register address = 0x7F1  registers count=1 payload size=2
  # TODO: Figure out how 'switch' behaves differently from 'number' when writing/setting it.
  # # Bypass valve manual override
  # - platform: modbus_controller
  #   modbus_controller_id: hru
  #   name: "42034 Bypass valve override"
  #   id: hru_bypass_valve_override
  #   # min_value: 0
  #   # max_value: 1
  #   # step: 1
  #   register_type: holding
  #   address: 2033
  #   value_type: U_WORD
  #   bitmask: 0x1
  #   # use_write_multiple: true
  #   icon: mdi:toggle-switch

  # Proper implementation of Bypass on/auto switch:
  - platform: template
    name: "Bypass valve" # Off = auto, On = manual/force open
    id: hru_bypass_valve_switch
    icon: mdi:toggle-switch-variant
    lambda: |-
      return id(hru_bypass_valve_override).state == 1 && id(hru_bypass_valve_pos).state == 0;
    turn_on_action:
      then:
        - if:
            condition:
              lambda: "return id(hru_m3h_exhaust_internal).state > 200;"
            then: 
              # Force exhaust fan to below 200, and wait for it to spin down
              - logger.log: "Exhaust flow > 200, temporarily lower exhaust flow"
              - number.set:
                  id: hru_exhaust_fan_flow
                  value: 100
              - number.set:
                  id: hru_exhaust_fan_flow_override
                  value: 1
              - delay: 5s
              # Force Bypass valve into open mode (== 0) and wait for it to open
              - logger.log: "Open bypass valve after lowering exhaust flow"
              - number.set:
                  id: hru_bypass_valve_pos
                  value: 0 # == open
              - number.set:
                  id: hru_bypass_valve_override
                  value: 1
              - delay: 5s
              # Reset exhaust fan to auto mode
              - logger.log: "Resetting exhaust flow to auto mode"
              - number.set:
                  id: hru_exhaust_fan_flow_override
                  value: 0
              - number.set:
                  id: hru_exhaust_fan_flow
                  value: 0
            else:
              - logger.log: "Open bypass valve"
              - number.set:
                  id: hru_bypass_valve_pos
                  value: 0 # == open
              - number.set:
                  id: hru_bypass_valve_override
                  value: 1
    turn_off_action:
      then:
        - logger.log: "Reset bypass valve to auto"
        - number.set:
            id: hru_bypass_valve_override
            value: 0

number:
  # Error counting registers
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40201 error 01 count"
    id: hru_error01count
    register_type: holding
    address: 200 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40202 error 02 count"
    id: hru_error02count
    register_type: holding
    address: 201 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40203 error 03 count"
    id: hru_error03count
    register_type: holding
    address: 202 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40204 error 04 count"
    id: hru_error04count
    register_type: holding
    address: 203 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40211 error 11 count"
    id: hru_error11count
    register_type: holding
    address: 210 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40212 error 12 count"
    id: hru_error12count
    register_type: holding
    address: 211 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40213 error 13 count"
    id: hru_error13count
    register_type: holding
    address: 212 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40214 error 14 count"
    id: hru_error14count
    register_type: holding
    address: 213 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40215 error 15 count"
    id: hru_error15count
    register_type: holding
    address: 214 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40216 error 16 count"
    id: hru_error16count
    register_type: holding
    address: 215 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40217 error 17 count"
    id: hru_error17count
    register_type: holding
    address: 216 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40218 error 18 count"
    id: hru_error18count
    register_type: holding
    address: 217 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40219 error 19 count"
    id: hru_error19count
    register_type: holding
    address: 218 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40220 error 20 count"
    id: hru_error20count
    register_type: holding
    address: 219 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40221 error 21 count"
    id: hru_error21count
    register_type: holding
    address: 220 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40222 error 22 count"
    id: hru_error22count
    register_type: holding
    address: 221 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40223 error 23 count"
    id: hru_error23count
    register_type: holding
    address: 222 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40231 error 31 count"
    id: hru_error31count
    register_type: holding
    address: 230 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40232 error 32 count"
    id: hru_error32count
    register_type: holding
    address: 231 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40233 error 33 count"
    id: hru_error33count
    register_type: holding
    address: 232 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "40234 error 34 count"
    id: hru_error34count
    register_type: holding
    address: 233 # 0x000E
    value_type: U_WORD
    skip_updates: 6
    use_write_multiple: true
    icon: mdi:counter

  # [E][modbus_controller:088]: Modbus error function code: 0x3 exception: 2
  # [E][modbus_controller:097]: Modbus error - last command: function code=0x3  register address = 0x1F3  registers count=1 payload size=0
  # # Write-only register to reboot unit
  # - platform: modbus_controller
  #   modbus_controller_id: hru
  #   name: "40500 Reboot unit"
  #   id: hru_reboot
  #   min_value: 0
  #   max_value: 1
  #   step: 1
  #   register_type: holding
  #   address: 499 # 0x000E
  #   value_type: U_WORD
  #   # skip_updates: 10 # ???
  #   # use_write_multiple: true # ???
  #   icon: mdi:power-cycle

  # Actual ventilation level, synchronized with BRDG (in-room RF-* units)
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42001 Actual ventilation level"
    id: hru_actual_level
    min_value: 1
    max_value: 25
    step: 1
    register_type: holding
    address: 2000 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:fan
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42002 Actual ventilation level override"
    id: hru_actual_level_override
    min_value: 0
    max_value: 1
    step: 1
    register_type: holding
    address: 2001 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:toggle-switch

  # [E][modbus_controller:088]: Modbus error function code: 0x3 exception: 2
  # [E][modbus_controller:097]: Modbus error - last command: function code=0x3  register address = 0x7DA  registers count=4 payload size=0
  # # Supply demand
  # - platform: modbus_controller
  #   modbus_controller_id: hru
  #   name: "42011 Supply demand"
  #   id: hru_supply_demand
  #   min_value: 0
  #   max_value: 65535 # max cap ???
  #   step: 1
  #   register_type: holding
  #   address: 2010 # 0x000E
  #   value_type: U_WORD
  #   use_write_multiple: true
  #   unit_of_measurement: "m3/h"
  #   icon: mdi:home-import-outline
  # - platform: modbus_controller
  #   modbus_controller_id: hru
  #   name: "42012 Supply demand override"
  #   id: hru_supply_demand_override
  #   min_value: 0
  #   max_value: 1
  #   step: 1
  #   register_type: holding
  #   address: 2011 # 0x000E
  #   value_type: U_WORD
  #   use_write_multiple: true
  #   icon: mdi:toggle-switch
  #
  # # Exhaust demand
  # - platform: modbus_controller
  #   modbus_controller_id: hru
  #   name: "42013 Exhaust demand"
  #   id: hru_exhaust_demand
  #   min_value: 0
  #   max_value: 65535 # max cap ???
  #   step: 1
  #   register_type: holding
  #   address: 2012 # 0x000E
  #   value_type: U_WORD
  #   use_write_multiple: true
  #   unit_of_measurement: "m3/h"
  #   icon: mdi:home-export-outline
  # - platform: modbus_controller
  #   modbus_controller_id: hru
  #   name: "42014 Exhaust demand override"
  #   id: hru_exhaust_demand_override
  #   min_value: 0
  #   max_value: 1
  #   step: 1
  #   register_type: holding
  #   address: 2013 # 0x000E
  #   value_type: U_WORD
  #   use_write_multiple: true
  #   icon: mdi:toggle-switch

  # Supply fan flow (no mass balance)
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42021 Supply fan flow"
    id: hru_supply_fan_flow
    min_value: 0
    max_value: 65535 # max cap ???
    step: 1
    register_type: holding
    address: 2020 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    unit_of_measurement: "m3/h"
    icon: mdi:home-import-outline
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42022 Supply fan flow override"
    id: hru_supply_fan_flow_override
    min_value: 0
    max_value: 1
    step: 1
    register_type: holding
    address: 2021 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:toggle-switch

  # Exhaust fan flow (no mass balance)
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42023 Exhaust fan flow"
    id: hru_exhaust_fan_flow
    min_value: 0
    max_value: 65535 # max cap ???
    step: 1
    register_type: holding
    address: 2022 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    unit_of_measurement: "m3/h"
    icon: mdi:home-export-outline
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42024 Exhaust fan flow override"
    id: hru_exhaust_fan_flow_override
    min_value: 0
    max_value: 1
    step: 1
    register_type: holding
    address: 2023 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:toggle-switch

  # Frost valve
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42031 Frost valve position"
    id: hru_frost_valve_pos
    min_value: 0
    max_value: 510
    step: 1
    register_type: holding
    address: 2030 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:valve
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42032 Frost valve override"
    id: hru_frost_valve_override
    min_value: 0
    max_value: 1
    step: 1
    register_type: holding
    address: 2031 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:toggle-switch

  # Bypass valve
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42033 Bypass valve position"
    id: hru_bypass_valve_pos
    min_value: 0
    max_value: 550
    step: 550
    register_type: holding
    address: 2032 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:valve
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42034 Bypass valve override"
    id: hru_bypass_valve_override
    min_value: 0
    max_value: 1
    step: 1
    register_type: holding
    address: 2033 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:toggle-switch

  # Zone valve stepper
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42035 Zone 1 valve position"
    id: hru_zone1_valve_pos
    min_value: 0
    max_value: 550
    step: 1
    register_type: holding
    address: 2034 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:valve
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42036 Zone 1 valve override"
    id: hru_zone1_valve_override
    min_value: 0
    max_value: 1
    step: 1
    register_type: holding
    address: 2035 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:toggle-switch
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42037 Zone 2 valve position"
    id: hru_zone2_valve_pos
    min_value: 0
    max_value: 550
    step: 1
    register_type: holding
    address: 2036 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:valve
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42038 Zone 2 valve override"
    id: hru_zone2_valve_override
    min_value: 0
    max_value: 1
    step: 1
    register_type: holding
    address: 2037 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:toggle-switch
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42039 Zone 3 valve position"
    id: hru_zone3_valve_pos
    min_value: 0
    max_value: 550
    step: 1
    register_type: holding
    address: 2038 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:valve
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42040 Zone 3 valve override"
    id: hru_zone3_valve_override
    min_value: 0
    max_value: 1
    step: 1
    register_type: holding
    address: 2039 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:toggle-switch
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42041 Zone 4 valve position"
    id: hru_zone4_valve_pos
    min_value: 0
    max_value: 550
    step: 1
    register_type: holding
    address: 2040 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:valve
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42041 Zone 4 valve override"
    id: hru_zone4_valve_override
    min_value: 0
    max_value: 1
    step: 1
    register_type: holding
    address: 2041 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:toggle-switch

  # Zone levels
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42201 Zone 1 ventilation level"
    id: hru_zone1_level
    min_value: 0
    max_value: 25
    step: 1
    register_type: holding
    address: 2200 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:fan-speed-1
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42202 Zone 1 ventilation level override"
    id: hru_zone1_level_override
    min_value: 0
    max_value: 1
    step: 1
    register_type: holding
    address: 2201 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:toggle-switch
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42203 Zone 2 ventilation level"
    id: hru_zone2_level
    min_value: 0
    max_value: 25
    step: 1
    register_type: holding
    address: 2202 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:fan-speed-2
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42204 Zone 2 ventilation level override"
    id: hru_zone2_level_override
    min_value: 0
    max_value: 1
    step: 1
    register_type: holding
    address: 2203 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:toggle-switch
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42205 Zone 3 ventilation level"
    id: hru_zone3_level
    min_value: 0
    max_value: 25
    step: 1
    register_type: holding
    address: 2204 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:fan-speed-3
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42206 Zone 3 ventilation level override"
    id: hru_zone3_level_override
    min_value: 0
    max_value: 1
    step: 1
    register_type: holding
    address: 2205 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:toggle-switch
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42207 Zone 4 ventilation level"
    id: hru_zone4_level
    min_value: 0
    max_value: 25
    step: 1
    register_type: holding
    address: 2206 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:fan-plus
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42208 Zone 4 ventilation level override"
    id: hru_zone4_level_override
    min_value: 0
    max_value: 1
    step: 1
    register_type: holding
    address: 2207 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:toggle-switch
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42209 Zone 5 ventilation level"
    id: hru_zone5_level
    min_value: 0
    max_value: 25
    step: 1
    register_type: holding
    address: 2208 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:fan-plus
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42210 Zone 5 ventilation level override"
    id: hru_zone5_level_override
    min_value: 0
    max_value: 1
    step: 1
    register_type: holding
    address: 2209 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:toggle-switch
  
  # Zone flow demand
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42211 Zone 1 flow demand"
    id: hru_zone1_ask
    min_value: 0
    max_value: 399  # max cap ???
    step: 1
    register_type: holding
    address: 2210 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    unit_of_measurement: "m3/h"
    icon: mdi:fan-speed-1
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42212 Zone 1 flow demand override"
    id: hru_zone1_ask_override
    min_value: 0
    max_value: 1
    step: 1
    register_type: holding
    address: 2211 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:toggle-switch
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42213 Zone 2 flow demand"
    id: hru_zone2_ask
    min_value: 0
    max_value: 399  # max cap ???
    step: 1
    register_type: holding
    address: 2212 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    unit_of_measurement: "m3/h"
    icon: mdi:fan-speed-2
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42214 Zone 2 flow demand override"
    id: hru_zone2_ask_override
    min_value: 0
    max_value: 1
    step: 1
    register_type: holding
    address: 2213 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:toggle-switch
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42215 Zone 3 flow demand"
    id: hru_zone3_ask
    min_value: 0
    max_value: 399  # max cap ???
    step: 1
    register_type: holding
    address: 2214 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    unit_of_measurement: "m3/h"
    icon: mdi:fan-speed-3
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42216 Zone 3 flow demand override"
    id: hru_zone3_ask_override
    min_value: 0
    max_value: 1
    step: 1
    register_type: holding
    address: 2215 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:toggle-switch
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42217 Zone 4 flow demand"
    id: hru_zone4_ask
    min_value: 0
    max_value: 399  # max cap ???
    step: 1
    register_type: holding
    address: 2216 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    unit_of_measurement: "m3/h"
    icon: mdi:fan-plus
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42218 Zone 4 flow demand override"
    id: hru_zone4_ask_override
    min_value: 0
    max_value: 1
    step: 1
    register_type: holding
    address: 2217 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:toggle-switch
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42219 Zone 5 flow demand"
    id: hru_zone5_ask
    min_value: 0
    max_value: 399  # max cap ???
    step: 1
    register_type: holding
    address: 2218 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    unit_of_measurement: "m3/h"
    icon: mdi:fan-plus
  - platform: modbus_controller
    modbus_controller_id: hru
    name: "42220 Zone 5 flow demand override"
    id: hru_zone5_ask_override
    min_value: 0
    max_value: 1
    step: 1
    register_type: holding
    address: 2219 # 0x000E
    value_type: U_WORD
    use_write_multiple: true
    icon: mdi:toggle-switch
